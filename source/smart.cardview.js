
/* Smart HTML Elements v4.0.0 (2019-Aug) 
Copyright (c) 2011-2019 jQWidgets. 
License: https://htmlelements.com/license/ */

Smart("smart-card-view",class extends Smart.BaseElement{static get properties(){return{addNewButton:{value:!1,type:"boolean"},cardHeight:{value:null,type:"number?"},cellOrientation:{value:"vertical",allowedValues:["horizontal","vertical"],type:"string"},collapsible:{value:!1,type:"boolean"},columns:{value:[],type:"object",reflectToAttribute:!1},coverField:{value:null,type:"string?"},coverMode:{value:"crop",allowedValues:["fit","crop"],type:"string"},dataSource:{value:null,type:"object?",reflectToAttribute:!1},editable:{value:!1,type:"boolean"},headerPosition:{value:"none",allowedValues:["none","top","bottom"],type:"string"},messages:{value:{en:{addImage:"Add",apply:"Apply",cancel:"Cancel",coverField:"Cover field",crop:"Crop",customizeCards:"Customize cards",filter:"Filter",filteredByMultiple:"{{n}} filters",filteredByOne:"1 filter",fit:"Fit",imageUrl:"New image URL:",incorrectStructure:"\"dataSource\" must be an instance of Smart.DataAdapter or an array of objects with key-value pairs.",nextRecord:"Next record",noCoverField:"No cover field",ok:"OK",previousRecord:"Previous record",removeImage:"Remove",sort:"Sort",sortedByMultiple:"Sorted by {{n}} fields",sortedByOne:"Sorted by 1 field",toggleVisibility:"Toggle field visibility"}}},scrollMode:{value:"physical",allowedValues:["physical","virtual","infinite","deferred"],type:"string"},searchPlaceholder:{value:"Find in view",type:"string"},titleField:{value:null,type:"string?"}}}static get listeners(){return{click:"_clickHandler",move:"_moveHandler",next:"_prevNextHandler",prev:"_prevNextHandler",resize:"_resizeHandler","addNewButton.click":"addRecord","container.close":"_windowCloseHandler","container.opening":"_stopPropagation","header.apply":"_applyHandler","header.cancel":"closePanel","document.up":"_documentUpHandler"}}static get requires(){return{"Smart.Card":"smart.card.js","Smart.Carousel":"smart.carousel.js","Smart.ColumnPanel":"smart.gridpanel.js","Smart.DataAdapter":"smart.data.js","Smart.Input":"smart.input.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.SwitchButton":"smart.switchbutton.js"}}get hasStyleObserver(){return!1}get editInfo(){return this._editInfo}template(){return`<div id="container">
                    <div id="header" class="smart-card-view-header smart-hidden">
                        <div id="customizeCardsButton" class="smart-card-view-header-button smart-card-view-customize-button smart-unselectable"><div></div></div>
                        <div id="filterButton" class="smart-card-view-header-button smart-card-view-filter-button smart-unselectable"><div></div></div>
                        <div id="sortButton" class="smart-card-view-header-button smart-card-view-sort-button smart-unselectable"><div></div></div>
                        <div id="searchButton" class="smart-card-view-header-button smart-card-view-search-button smart-unselectable"></div>
                        <div id="headerDropDown" class="smart-card-view-header-drop-down smart-visibility-hidden">
                            <div id="customize" class="smart-hidden"></div>
                            <div id="filter" class="smart-hidden"></div>
                            <div id="sort" class="smart-hidden"></div>
                            <div id="search" class="smart-hidden">
                                <input type="text" placeholder="[[searchPlaceholder]]" />
                                <div id="searchLabel" class="smart-card-view-search-label"></div>
                                <div id="searchPrev" class="smart-card-view-search-prev"></div>
                                <div id="searchNext" class="smart-card-view-search-next"></div>
                                <div id="searchClear" class="smart-card-view-search-clear"></div>
                            </div>
                        </div>
                    </div>
                    <smart-scroll-viewer id="scrollViewer" animation="[[animation]]" horizontal-scroll-bar-visibility="hidden">
                        <div id="cardContainer" class="smart-card-container"></div>
                    </smart-scroll-viewer>
                    <div id="loadingIndicatorContainer" class="smart-loader-container smart-hidden">
                        <span id="loadingIndicator" class="smart-loader"></span>
                    </div>
                    <div id="addNewButton" class="smart-add-new-button"></div>
                </div>`}ready(){super.ready();const e=this,t=e.dataSource,a=e.scrollMode;Smart.Utilities.NumberRenderer&&(e._numericFormatter=new Smart.Utilities.NumberRenderer),e._gap=parseFloat(getComputedStyle(e).getPropertyValue("--smart-card-view-gap")),e._cards=[],e._collapsed={},e._cardHeight=e.cardHeight,e._autoCardHeight=null===e._cardHeight,e._cachedWidth=e.offsetWidth,e._cachedHeight=e.offsetHeight,e._appliedFiltering={filters:[],operator:"and"},e._appliedSorting={dataFields:[],dataTypes:[],orderBy:[]},e._cardScrolling={},e._start={view:0,data:0},e._normalizeDataSource(),e._getVisibleRecords(),e._normalizeColumns(),e._handleHeaderPosition(),e._localizeHeader(),"deferred"===a?e.$.scrollViewer.$.verticalScrollBar.mechanicalAction="switchWhenReleased":("virtual"===a||"infinite"===a)&&t&&t.onVirtualDataSourceRequested===void 0&&(e.scrollMode="physical"),e._createTemplate(),"infinite"===a?e._requestInitialCards():e._createCards(),e.$.scrollViewer._verticalScrollbarHandler=e._onVerticalChange.bind(e),e.$.scrollViewer.hasStyleObserver=!1,e.$.scrollViewer.$.verticalScrollBar.hasStyleObserver=!1,e.$.scrollViewer.$.horizontalScrollBar.hasStyleObserver=!1}addFilter(e,t="and"){const a=this;if(!Array.isArray(e))return;let i;if(arguments[2]?i={filters:arguments[2],operator:t}:(i={filters:[],operator:t},e.forEach(e=>{e[1].filters.forEach(t=>{i.filters.push([e[0],t.condition,t.value])})})),JSON.stringify(i)!==JSON.stringify(a._appliedFiltering)){const r=i.filters.length;a._appliedFiltering=i;try{a.dataSource._filter(e,t)}catch(e){return}return a._getVisibleRecords(),a._refresh(),0===r?(a.$.filterButton.firstElementChild.innerHTML=a.localize("filter"),void a.$.filterButton.classList.remove("filtered")):void(a.$.filterButton.firstElementChild.innerHTML=1===r?a.localize("filteredByOne"):a.localize("filteredByMultiple",{n:r}),a.$.filterButton.classList.add("filtered"))}}addRecord(){this}addSort(e,t){function a(e,a){const l=i.columns.find(t=>t.dataField===e);if(l){let i=Array.isArray(t)?t[a]:"string"==typeof t?t:"ascending";n.dataFields.push(e),n.dataTypes.push(r.dataFields.find(t=>t.name===e).dataType),i=-1===i.indexOf("desc")?"ascending":"descending",n.orderBy.push(i)}}const i=this,r=i.dataSource,l=JSON.stringify(i._appliedSorting);let n;if(0!==arguments.length&&r&&0!==r.length){if(1===arguments.length&&"object"==typeof e)n=e;else if(n={dataFields:[],dataTypes:[],orderBy:[]},Array.isArray(e))e.forEach(a);else if("string"==typeof e)a(e,0);else return;if(i.closePanel(),i._appliedSorting=n,l!==JSON.stringify(i._appliedSorting)){const e=i._getFractionOfMax(),t=i._appliedSorting.dataFields.length;if(r.sortBy(n.dataFields,n.dataTypes,n.orderBy),i._getVisibleRecords(),i._dataSourceProcessed=!0,i._setFractionOfMax(e),delete i._dataSourceProcessed,0===t)return i.$.sortButton.firstElementChild.innerHTML=i.localize("sort"),void i.$.sortButton.classList.remove("sorted");i.$.sortButton.firstElementChild.innerHTML=1===t?i.localize("sortedByOne"):i.localize("sortedByMultiple",{n:t}),i.$.sortButton.classList.add("sorted")}}}closePanel(){this.$.headerDropDown.classList.add("smart-visibility-hidden")}hideColumn(e){this._toggleColumn(e,!1)}openCustomizePanel(){const e=this,t=e.dataSource;if(!t||0===t.length)return;const a=e.$.customize,i=e.columns.map(t=>{const a=Object.assign({},t);return a.disableToggle=-1!==[e.coverField,e.titleField].indexOf(a.dataField),a});let r,l,n;if(e.$.headerDropDown.classList.add("customize-panel"),e.$.headerDropDown.classList.remove("filter-panel","sort-panel"),a.classList.remove("smart-hidden"),e.$.filter.classList.add("smart-hidden"),e.$.sort.classList.add("smart-hidden"),e.$.search.classList.add("smart-hidden"),!e._customizePartCreated){const t=document.createDocumentFragment(),a=document.createElement("div"),d=document.createElement("div"),o=document.createElement("div");r=document.createElement("smart-switch-button"),l=document.createElement("smart-input"),n=document.createElement("smart-column-panel"),o.innerHTML=e.localize("coverField"),r.inverted=!0,r.animation=e.animation,r.theme=e.theme,l.dataSource=[e.localize("noCoverField")].concat(e.columns.filter(e=>e.image)),l.dropDownButtonPosition="right",l.readonly=!0,l.animation=e.animation,l.theme=e.theme,n.dataSource=i,n.animation=e.animation,n.theme=e.theme,d.appendChild(o),d.appendChild(r),a.classList.add("smart-card-view-customize-top"),a.appendChild(d),a.appendChild(l),t.appendChild(a),t.appendChild(n),e.$.customize.appendChild(t),e._customizePartCreated=!0}else r=a.getElementsByTagName("smart-switch-button")[0],l=a.getElementsByTagName("smart-input")[0],n=a.children[1],n.set("dataSource",i),n.propertyChangedHandler("dataSource",void 0,i);r.checked="fit"===e.coverMode,l.value=e.coverField?e.columns.find(t=>t.dataField===e.coverField).label:e.localize("noCoverField"),e._changedVisibility=new Map,e._openHeaderDropDown(e.$.customizeCardsButton)}openFilterPanel(){const e=this,t=e.dataSource;if(!t||0===t.length)return;const a=e.columns.map(e=>{const a=Object.assign({},e);return a.dataType=t.dataFields.find(e=>e.name===a.dataField).dataType,a});let i;e.$.headerDropDown.classList.add("filter-panel"),e.$.headerDropDown.classList.remove("customize-panel","sort-panel","search-panel"),e.$.filter.classList.remove("smart-hidden"),e.$.customize.classList.add("smart-hidden"),e.$.sort.classList.add("smart-hidden"),e.$.search.classList.add("smart-hidden"),e._filterPartCreated?(i=e.$.filter.firstElementChild,i.set("operator",e._appliedFiltering.operator),i.set("value",e._appliedFiltering.filters),i._applyValue()):(i=document.createElement("smart-multi-column-filter-panel"),i.dataSource=a,i.operator=e._appliedFiltering.operator,i.value=e._appliedFiltering.filters,i.animation=e.animation,i.theme=e.theme,e.$.filter.appendChild(i),e._filterPartCreated=!0),e._openHeaderDropDown(e.$.filterButton)}openSortPanel(){const e=this,t=e.dataSource;if(!t||0===t.length)return;const a=e.columns.map(a=>{const i=Object.assign({},a),r=e._appliedSorting.dataFields.indexOf(i.dataField);return i.dataType=t.dataFields.find(e=>e.name===i.dataField).dataType,i.sortIndex=r,-1!==r&&(i.sortDirection=e._appliedSorting.orderBy[r]),i});let i;e.$.headerDropDown.classList.add("sort-panel"),e.$.headerDropDown.classList.remove("customize-panel","filter-panel","search-panel"),e.$.sort.classList.remove("smart-hidden"),e.$.customize.classList.add("smart-hidden"),e.$.filter.classList.add("smart-hidden"),e.$.search.classList.add("smart-hidden"),e._sortPartCreated?(i=e.$.sort.firstElementChild,i.set("dataSource",a),i.propertyChangedHandler("dataSource",void 0,a)):(i=document.createElement("smart-sort-panel"),i.dataSource=a,i.animation=e.animation,i.theme=e.theme,e.$.sort.appendChild(i),e._sortPartCreated=!0),e._openHeaderDropDown(e.$.sortButton)}removeFilter(){this.addFilter([])}removeSort(){this.addSort({dataFields:[],dataTypes:[],orderBy:[]})}showColumn(e){this._toggleColumn(e,!0)}propertyChangedHandler(e,t,a){super.propertyChangedHandler(e,t,a);const i=this;if("dataSource"===e||i.dataSource&&0!==i.dataSource.length)switch(e){case"animation":case"theme":if(i._cards.forEach(t=>{const i=t.getElementsByTagName("smart-carousel");i&&(i[e]=a)}),i._editInfo)for(let t in i._editInfo.window[e]=a,i._editInfo.editors)i._editInfo.editors[t].element[e]=a;i._customizePartCreated&&(i.$.customize.firstElementChild.firstElementChild.children[1][e]=a,i.$.customize.firstElementChild.children[1][e]=a,i.$.customize.children[1][e]=a),i._filterPartCreated&&(i.$.filter.firstElementChild[e]=a),i._sortPartCreated&&(i.$.sort.firstElementChild[e]=a);break;case"disabled":case"unfocusable":case"readonly":break;case"cardHeight":i._updateCardHeight(a);break;case"cellOrientation":case"collapsible":i.$.scrollViewer.refresh();break;case"columns":i._updateColumns();break;case"coverField":case"titleField":i._createTemplate(),i._refresh();break;case"dataSource":i._close(),i._normalizeDataSource(),i._getVisibleRecords(),i._clearFilterAndSortUI(),i._normalizeColumns(),i._createTemplate(),i._refresh();break;case"editable":!a&&i._editInfo&&i._editInfo.window.close();break;case"headerPosition":i._handleHeaderPosition(),("none"===a||"none"===t)&&i._refreshView();break;case"locale":case"messages":i._localizeHeader();break;case"scrollMode":{const e=["virtual","infinite"];if(-1!==e.indexOf(a)||-1!==e.indexOf(t))return void(i.scrollMode=t);i.$.scrollViewer.$.verticalScrollBar.mechanicalAction="deferred"===a?"switchWhenReleased":"switchWhileDragging";break}}}_updateColumns(){const e=this;e._normalizeColumns(),e._createTemplate(),e._refresh()}_clickHandler(e){const t=this,a=e.target;if(!a.classList.contains("smart-indicator")){const i=a.closest("smart-card");if(!a.classList.contains("smart-arrow-up")){if(t.$.header.contains(a))return void t._headerClickHandler(e);if(!t.editable)return;if(i)t._openEditDialog(i.dataId);else if(a.closest(".ok"))t._editInfo.ok=!0,t._editInfo.window.close();else if(a.closest(".cancel"))t._editInfo.window.close();else if(a.closest(".add")){const e=a.closest(".container"),i=e.firstElementChild;if(""!==i.value.trim()){const a=document.createElement("div");a.className="thumbnail",a.style.backgroundImage=`url("${i.value}")`,a.title=t.localize("removeImage"),e.parentElement.firstElementChild.appendChild(a),i.value=""}}else if(a.classList.contains("thumbnail"))a.parentElement.removeChild(a);else if(a.classList.contains("toggle-visibility")){const e=t.columns.find(e=>a.parentElement.classList.contains(e.dataField));a.classList.toggle("hidden"),t._changedVisibility.set(e,!a.classList.contains("hidden"))}return}if(i){const e=i.getElementsByClassName("smart-card-view-content")[0],r=i.dataId;e.removeEventListener("transitionend",t._transitionendHandlerExpand),e.removeEventListener("transitionend",t._transitionendHandlerCollapse),t._collapsed[r]?(delete t._collapsed[r],t.hasAnimation?t._expandDataContainer(e):(i.classList.remove("collapsed"),a.classList.remove("collapsed"),e.classList.remove("smart-visibility-hidden"),t.$.scrollViewer.refresh()),window.getSelection().removeAllRanges()):(t._collapsed[r]=!0,i.classList.add("collapsed"),a.classList.add("collapsed"),t.hasAnimation?t._collapseDataContainer(e):(e.classList.add("smart-visibility-hidden"),t.$.scrollViewer.refresh()))}}}_expandDataContainer(e){const t=this,a=e.style.height,i=e.scrollHeight+"px";return e.style.height=i,e.classList.remove("smart-visibility-hidden"),e.previousElementSibling.children[1].classList.remove("collapsed"),a!==i&&(parseFloat(a)||parseFloat(i))?void e.addEventListener("transitionend",t._transitionendHandlerExpand):void t._transitionendHandlerExpand(t,e)}_transitionendHandlerExpand(){let e,t;1===arguments.length?(t=this,e=t.closest("smart-card-view")):(e=arguments[0],t=arguments[1]),t.removeEventListener("transitionend",e._transitionendHandlerExpand),t.style.height=null,t.parentElement.parentElement.parentElement.classList.remove("collapsed"),e.$.scrollViewer.refresh()}_collapseDataContainer(e){const t=this,a=e.scrollHeight+"px";e.style.transition="none",requestAnimationFrame(function(){e.style.height=a,e.style.transition=null,requestAnimationFrame(function(){e.style.height="0px",e.classList.add("smart-visibility-hidden"),"0px"==a&&t._transitionendHandlerCollapse(t,e)})}),e.addEventListener("transitionend",t._transitionendHandlerCollapse)}_transitionendHandlerCollapse(){let e,t;1===arguments.length?(t=this,e=t.closest("smart-card-view")):(e=arguments[0],t=arguments[1]),t.removeEventListener("transitionend",e._transitionendHandlerCollapse),t.style.height=null,e.$.scrollViewer.refresh()}_openEditDialog(e){const t=this,a=t._visibleSource,i=a[e],r=t.$.fireEvent("opening",{record:i});if(r.defaultPrevented)return;if(t._changedVisibility=new Map,t._editInfo&&!t._editInfo.updateWindowContent)return void t._updateEditedView(e);const l=document.createDocumentFragment(),n={};if(t.columns.forEach(function(e){const a=e.dataField,r=i[a],d=document.createElement("div");let o;if(d.className=`smart-card-view-label${e.icon?" icon "+e.icon:""}`,d.setAttribute("data-field",a),d.innerHTML=`${e.label}<span class="toggle-visibility${!1===e.visible?" hidden":""}${a===t.coverField||a===t.titleField?" smart-hidden":""}" title="${t.localize("toggleVisibility")}"></span>`,l.appendChild(d),e.image)return o=document.createElement("div"),o.className="smart-card-view-editor image",o.innerHTML=`<div>${t._updateImgThumbNails(r)}</div>
<div class="label">${t.localize("imageUrl")}</div>
<div class="container">
    <smart-input></smart-input>
    <smart-button class="add" title=${t.localize("addImage")}>+</smart-button>
</div>`,l.appendChild(o),void(n[a]={element:o,type:"image"});const s=t.dataSource.dataFields.find(t=>t.name===e.dataField).dataType;"date"===s?(o=document.createElement("smart-date-time-picker"),o.calendarButton=!0,o.dropDownAppendTo="body",o.dropDownDisplayMode="auto",o.value=r,e.formatSettings&&e.formatSettings.formatString&&(o.formatString=e.formatSettings.formatString)):"number"===s?(o=document.createElement("smart-numeric-text-box"),o.inputFormat="floatingPoint",o.spinButtons=!0,o.value=r,e.formatSettings&&e.formatSettings.formatString&&(o.outputFormatString=e.formatSettings.formatString)):"boolean"===s?(o=document.createElement("smart-check-box"),o.checked=r):(o="string"==typeof r&&50<r.length?document.createElement("textarea"):document.createElement("smart-input"),o.value=r),o.className="smart-card-view-editor",o.animation=t.animation,o.theme=t.theme,l.appendChild(o),n[a]={element:o,type:s}}),t._editInfo&&t._editInfo.updateWindowContent)return t._editInfo.window.clear(),t._editInfo.window.appendChild(l),t._editInfo.window.open(),t._editInfo.dataId=e,t._editInfo.editors=n,void delete t._editInfo.updateWindowContent;const d=document.createElement("smart-window"),o=document.createElement("template");o.innerHTML=`<smart-button class="ok primary">${t.localize("ok")}</smart-button><smart-button class="cancel">${t.localize("cancel")}</smart-button>`,d.classList.add("smart-visibility-hidden"),d.footerTemplate=o,d.headerButtons=["close","next","prev"],d.label=i[t.titleField],d.modal=!0,d.animation=t.animation,d.theme=t.theme,d.appendChild(l),t.$.container.appendChild(d),d.whenReady(()=>{d.$.buttonsContainer.firstElementChild.title=t.localize("previousRecord"),d.$.buttonsContainer.children[1].title=t.localize("nextRecord"),d.open()}),t._editInfo={dataId:e,editors:n,window:d}}_updateEditedView(e){const t=this,a=t._visibleSource[e];!a||a.isEmpty||(t._editInfo.dataId=e,t.columns.forEach(function(e){const i=e.dataField,r=a[i],l=t._editInfo.editors[i];"image"===l.type?l.element.firstElementChild.innerHTML=t._updateImgThumbNails(r):"boolean"===l.type?l.element.checked=r:l.element.value=r}),t._editInfo.window.label=a[t.titleField],t._editInfo.window.open())}_updateImgThumbNails(e){if(""===e.trim())return"";const t=e.split(",");let a="";return t.forEach(e=>a+=`<div class="thumbnail" style="background-image: url('${e}');" title="${this.localize("removeImage")}"></div>`),a}_moveHandler(e){"touchmove"===e.originalEvent.type&&e.originalEvent.preventDefault()}_prevNextHandler(e){const t=this,a=t._editInfo.dataId,i="prev"===e.type?a-1:a+1;t._visibleSource[i]&&!t._visibleSource[i].isEmpty&&(t._saveChanges(),t._updateEditedView(i))}_saveChanges(){const e=this,t=e._editInfo.dataId,a=e._visibleSource[t],i=e._cards.filter(e=>e.dataId===t),r=i[i.length-1];e.columns.forEach(function(t){const i=t.dataField,l=e._editInfo.editors[i],n=l.element;if("image"===l.type){const t=[];if(Array.from(l.element.getElementsByClassName("thumbnail")).forEach(e=>{t.push(e.style.backgroundImage.replace(/url\(["'](.+)["']\)/g,"$1"))}),a[i]=t.join(","),r&&i===e.coverField)return void(r.getElementsByTagName("smart-carousel")[0].dataSource=t)}else a[i]="boolean"===l.type?n.checked:n.value;if(r)if(i===e.titleField)r.getElementsByClassName("smart-card-view-title")[0].firstElementChild.innerHTML=e._formatValue(a[i],t);else if(t.visible){const l=r.querySelector(`[data-field="${i}"] > .smart-card-view-value`);l&&(l.innerHTML=e._formatValue(a[i],t))}})}_close(){const e=this;e.closePanel(),e._editInfo&&e._editInfo.window.close()}_resizeHandler(){const e=this;e._suppressResizeHandler||e.hasAttribute("empty")||e.hasAttribute("no-matches")||(clearTimeout(e._resizeTimeout),e.$.loadingIndicatorContainer.classList.remove("smart-hidden"),e._resizeTimeout=setTimeout(function(){function t(){const t=e.$.scrollViewer.$.verticalScrollBar.value;e._refresh(),e.$.scrollViewer.$.verticalScrollBar.value=t}if(e.$.loadingIndicatorContainer.classList.add("smart-hidden"),e._cards.length===e._visibleSource.length)return e._cachedWidth=e.offsetWidth,e._cachedHeight=e.offsetHeight,void(0<e._cards.length&&e.$.scrollViewer.refresh());if(e.offsetHeight!==e._cachedHeight&&(e._cachedHeight=e.offsetHeight,20<=Math.abs(e._refreshedAtDimensions.height-e._cachedHeight)?t():e.$.scrollViewer.$.verticalScrollBar.max=e._scrollHeight-e.$.scrollViewer.$.scrollViewerContainer.offsetHeight),e.offsetWidth!==e._cachedWidth){const a=e._cardsPerRow;e._cachedWidth=e.offsetWidth,e._getCardsPerRow(),a!==e._cardsPerRow&&t()}},75))}_windowCloseHandler(e){const t=this;return t._editInfo&&e.target===t._editInfo.window?t._editInfo.ok?(t._updateColumnsVisibility(function(){t._saveChanges()}),void delete t._editInfo.ok):void t._changedVisibility.forEach(function(e,a){a.visible!==e&&t._editInfo.window.querySelector(`[data-field="${a.dataField}"]`).firstElementChild.classList.toggle("hidden")}):void 0}_updateColumnsVisibility(e,t){const a=this;let i=!1;a._changedVisibility.forEach(function(r,l){if(!0!==t&&l.visible===r)return;const n=l.dataField;l.visible=r,r?(a._cardContent=a._cardContent.replace(`class="smart-card-view-cell smart-hidden" data-field="${n}"`,`class="smart-card-view-cell" data-field="${n}"`),!e&&a.editInfo&&a._editInfo.window.querySelector(`[data-field="${n}"]`).firstElementChild.classList.remove("hidden")):(a._cardContent=a._cardContent.replace(`class="smart-card-view-cell" data-field="${n}"`,`class="smart-card-view-cell smart-hidden" data-field="${n}"`),!e&&a.editInfo&&a._editInfo.window.querySelector(`[data-field="${n}"]`).firstElementChild.classList.add("hidden")),a._cards.forEach(e=>{const t=e.querySelector(`[data-field="${n}"]`);t.classList.toggle("smart-hidden"),r&&(t.children[1].innerHTML=a._formatValue(a._visibleSource[e.dataId][n],l))}),i=!0}),e&&e(),a._autoCardHeight&&i&&a._updateCardHeight(null)}_stopPropagation(e){e.stopPropagation()}_applyHandler(e){const t=this,a=e.target,i=e.detail,r=t.$.customize,l=t.columns;if(r.contains(a)){const e=r.getElementsByTagName("smart-switch-button")[0],a=r.getElementsByTagName("smart-input")[0],n=e.checked?"fit":"crop";let d=l.find(e=>e.label===a.value)||null,o=!1;if(n!==t.coverMode&&(t.coverMode=n),d&&(d=d.dataField),d!==t.coverField&&(t.coverField=d,o=!0),o||i.positionChanged){const e=t._getFractionOfMax();t.columns=i.value,t._createTemplate(),t._refresh(),t._setFractionOfMax(e),t._editInfo&&(t._editInfo.updateWindowContent=!0)}else i.value.forEach(e=>{const a=l.find(t=>t.dataField===e.dataField);a.visible!==e.visible&&t._changedVisibility.set(a,e.visible)}),t._updateColumnsVisibility()}else t.$.filter.contains(a)?t.addFilter(i.filters,i.operator,i.value):t.$.sort.contains(a)&&t.addSort(i.sortByInfo);t.closePanel()}_documentUpHandler(e){const t=this,a=e.originalEvent.target,i=a.closest("smart-scroll-viewer"),r=a.closest(".smart-drop-down"),l=t.$.header;a!==l&&l.contains(a)||i&&l.contains(i.ownerElement)||r&&(!r.ownerElement||l.contains(r.ownerElement))||t.closePanel()}_refresh(){const e=this,t=e.$.cardContainer;for(e._suppressResizeHandler=!0;t.firstChild;)t.removeChild(t.firstChild);e._cards=[],e._createCards(),0===e._visibleSource.length&&e.$.scrollViewer.refresh()}_normalizeDataSource(){const e=this;let t=e.dataSource;if(!(t instanceof Smart.DataAdapter)&&t){if(!Array.isArray(t))if("object"==typeof t&&0<Object.keys(t).length)t=[t];else return void e.error(e.localize("incorrectStructure"));if(Array.isArray(t)){if(0===t.length)return;const a=t[0],i=Object.keys(a);if(0===i.length)return void e.error(e.localize("incorrectStructure"));const r=[];i.forEach(e=>{const t=a[e];let i;i=t.constructor===Date?"date":"boolean"==typeof t?"boolean":isNaN(t)||null===t||""===t?"string":"number",r.push(`${e}: ${i}`)}),e.dataSource=new Smart.DataAdapter({dataSource:t,dataFields:r})}}}_normalizeColumns(){const e=this,t=e.dataSource,a=e.columns;if(!t||0===t.length)return;const i=t.dataFields,r=[];a.forEach(t=>{let a,l,n,d,o,s,c;"object"==typeof t?(a=t.dataField,l=t.formatFunction,n=t.formatSettings,d=t.icon,o=t.image||!1,s=t.label||a,c=a===e.titleField||a===e.coverField||!(t.visible!==void 0)||t.visible):"string"==typeof t&&(a=t,o=!1,s=a,c=!0),i.find(e=>e.name===a)&&r.push({dataField:a,formatFunction:l,formatSettings:n,icon:d,image:o,label:s,visible:c})}),0===r.length&&i.forEach(e=>{r.push({dataField:e.name,image:!1,label:e.name,visible:!0})}),r.find(t=>t.dataField===e.titleField)||(e.titleField=null),r.find(t=>t.dataField===e.coverField)||(e.coverField=null),e.columns=new Smart.ObservableArray(r),e.columns.canNotify=!0,e.columns.notify(function(t){if(e.context!==e&&t.newValue!==t.oldValue){if("update"===t.action)switch(t.propertyName){case"dataField":e._updateColumns();break;case"formatFunction":case"formatSettings":case"icon":case"image":case"label":e._createTemplate(),e._partialRefresh();break;case"visible":e._toggleColumn(t.target.dataField,t.newValue,!0);}else e._updateColumns();e._editInfo&&(e._editInfo.updateWindowContent=!0),e._close()}}),e._editInfo&&(e._editInfo.updateWindowContent=!0)}_handleHeaderPosition(){const e=this,t=e.headerPosition,a=e.$.header;return"none"===t?void e.$header.addClass("smart-hidden"):void(e.$header.removeClass("smart-hidden"),"top"===t&&a.nextElementSibling!==e.$.scrollViewer?e.$.container.insertBefore(a,e.$.scrollViewer):"bottom"===t&&a.previousElementSibling!==e.$.scrollViewer&&e.$.container.insertBefore(a,e.$.loadingIndicatorContainer))}_localizeHeader(){const e=this;e.$.customizeCardsButton.firstElementChild.innerHTML=e.localize("customizeCards"),e.$.filterButton.firstElementChild.innerHTML=0===e._appliedFiltering.filters.length?e.localize("filter"):1===e._appliedFiltering.filters.length?e.localize("filteredByOne"):e.localize("filteredByMultiple",{n:e._appliedFiltering.filters.length}),e.$.sortButton.firstElementChild.innerHTML=0===e._appliedSorting.dataFields.length?e.localize("sort"):1===e._appliedSorting.dataFields.length?e.localize("sortedByOne"):e.localize("sortedByMultiple",{n:e._appliedSorting.dataFields.length})}_headerClickHandler(e){function t(e,t){a.$.headerDropDown.classList.contains("smart-visibility-hidden")||e.classList.contains("smart-hidden")?a[t]():a.closePanel()}const a=this,i=e.target;a.$.customizeCardsButton.contains(i)?t(a.$.customize,"openCustomizePanel"):a.$.filterButton.contains(i)?t(a.$.filter,"openFilterPanel"):a.$.sortButton.contains(i)?t(a.$.sort,"openSortPanel"):i===a.$.searchButton&&t(a.$.search,"_openSearchPanel")}_openSearchPanel(){const e=this;e.$.headerDropDown.classList.add("search-panel"),e.$.headerDropDown.classList.remove("customize-panel","filter-panel","sort-panel"),e.$.search.classList.remove("smart-hidden"),e.$.customize.classList.add("smart-hidden"),e.$.filter.classList.add("smart-hidden"),e.$.sort.classList.add("smart-hidden"),e._openHeaderDropDown(e.$.searchButton)}_openHeaderDropDown(e){const t=this,a=t.$.headerDropDown;"top"===t.headerPosition?(a.style.bottom=null,a.style.top="100%"):(a.style.top=null,a.style.bottom="100%"),e===t.$.searchButton?(a.style.right=e.offsetParent.getBoundingClientRect().right-e.getBoundingClientRect().right+"px",a.style.left=null):(a.style.left=e.offsetLeft+"px",a.style.right=null),a.classList.remove("smart-visibility-hidden")}_createTemplate(){const e=this,t=e.titleField;let a="";a+=t?`<div class="smart-card-view-title"><div>{{${t}}}</div><div class="smart-arrow-up"></div></div>`:"<div class=\"smart-card-view-title empty\"><div>&nbsp;</div><div class=\"smart-arrow-up\"></div></div>",a+="<div class=\"smart-card-view-content\">",e.columns.forEach(i=>{i=e._getColumn(i);const r=i.dataField;!1!==i.visible&&(i.visible=!0);r===t||r===e.coverField||(a+=`<div class="smart-card-view-cell${i.visible?"":" smart-hidden"}" data-field="${r}"><div class="smart-card-view-label${i.icon?" icon "+i.icon:""}">${i.label}</div>
<div class="smart-card-view-value">{{${r}}}</div></div>`)}),a+="</div>",e._cardContent=a}_getColumn(e){return"string"==typeof e?e={label:e,dataField:e}:"object"==typeof e&&void 0===e.label&&(e.label=e.dataField),e}_requestInitialCards(){const e=this;e.setAttribute("loading",""),e.$.loadingIndicatorContainer.classList.remove("smart-hidden"),e.dataSource.onVirtualDataSourceRequested(function(){e._createCards(),e.removeAttribute("loading"),e.$.loadingIndicatorContainer.classList.add("smart-hidden")},{first:1/0,last:1/0,sorting:[],filtering:[],grouping:[],action:""})}_createCards(e){const t=this,a=t._visibleSource;if(!a||0===a.length)return;const i=t.scrollMode,r="virtual"===i,l=t.$.scrollViewer.$.scrollViewerContainer.offsetHeight;let n=a.length,d=1,o=0,s=0;t._ignoreVerticalChange=!0,r&&t.setAttribute("loading","");for(let r=0;r<n;r++){const i=t._createCard(a[r],r);if(t._cards.push(i),t.$.cardContainer.appendChild(i),t.$.scrollViewer.refresh(),t._autoCardHeight&&(s=Math.max(i.offsetHeight,s)),i.offsetTop>o&&(d++,o=i.offsetTop,!e&&(e=r)),3<=d&&0==t._cards.length%e&&t.$.cardContainer.offsetHeight>2*l&&t._cards.length+5<n)break}if(e=e||t._cards.length,"infinite"===i)for(;0!=t._cards.length%e;)t._createEmptyCard();t._autoCardHeight&&(t._cardHeight=s,t._cards.forEach(e=>e.style.height=s+"px"));const c=Math.ceil(n/e),m=(t._cardHeight+t._gap)*c-t._gap;t.$.scrollViewer.$.scrollViewerContentContainer.style.top=0,t.$.scrollViewer.$.verticalScrollBar.max=m-l,t._cardsPerRow=e,t._scrollHeight=m,t._refreshedAtDimensions={width:t._cachedWidth,height:t._cachedHeight};const h=Array.from(t.getElementsByTagName("smart-repeat-button"));h.forEach(e=>e.hasStyleObserver=!1),delete t._ignoreVerticalChange,delete t._suppressResizeHandler,r&&(t.$.loadingIndicatorContainer.classList.remove("smart-hidden"),t.dataSource.onVirtualDataSourceRequested(t._virtualDataSourceRequestedCallback.bind(t,0,0,!0),{first:0,last:t._cards.length,sorting:[],filtering:[],grouping:[],action:""}))}_virtualDataSourceRequestedCallback(e,t,a){const i=this;i._ignoreVerticalChange=!0,i.$.loadingIndicatorContainer.classList.add("smart-hidden"),i._updateVisibleCards(e,t,a),i.removeAttribute("loading"),delete i._ignoreVerticalChange}_createCard(e={},t){const a=this,i=a.coverField,r=document.createElement("smart-card"),l=document.createElement("div");if(requestAnimationFrame(()=>r.hasStyleObserver=!1),r.dataId=t,r.onscroll=function(){const e=a._visibleSource[this.dataId].$.id;a._cardScrolling[e]=this.scrollTop},a._autoCardHeight||(r.style.height=a._cardHeight+"px"),l.className="smart-card-data-container",l.innerHTML=a._applyTemplate(e),i){const t=document.createElement("smart-carousel");let l=e[i];l="string"==typeof l?l.split(","):[],t.dataSource=l,t.hideArrows=!0,t.unfocusable=!0,t.animation=a.animation,t.theme=a.theme,requestAnimationFrame(()=>t.hasStyleObserver=!1),r.appendChild(t)}return r.appendChild(l),r}_createEmptyCard(){const e=this,t=e._createCard({});t.classList.add("smart-hidden"),e._cards.push(t),e.$.cardContainer.appendChild(t)}_applyTemplate(e){const t=this;let a=t._cardContent;return t.columns.forEach(i=>{if(i.visible){const r=t._getColumn(i).dataField,l=new RegExp(`{{${r}}}`,"g"),n=t._formatValue(e[r],i);a=a.replace(l,n)}}),a.replace(/{{\w+}}/g,"")}_formatValue(e,t){const a=this;if(t.formatFunction&&e!==void 0&&null!==e)return t.formatFunction(e);if(t.formatSettings){let i="";return t.formatSettings.prefix&&(i+=t.formatSettings.prefix),t.formatSettings.formatString&&void 0!==e&&null!==e&&(e.constructor===Date?Smart.Utilities.DateTime&&(e=new Smart.Utilities.DateTime(e).toString(t.formatSettings.formatString)):e instanceof Smart.Utilities.DateTime?e=e.toString(t.formatSettings.formatString):!isNaN(e)&&a._numericFormatter&&(e=a._numericFormatter.formatNumber(e,t.formatSettings.formatString))),i+=e,t.formatSettings.sufix&&(i+=t.formatSettings.sufix),i}return e}_getCardsPerRow(){const e=this,t=e._cards;if(0===t.length)return void(e._cardsPerRow=0);let a=t[0].offsetTop,r=1;for(let e=1;e<t.length&&!(t[e].offsetTop>a);e++)r++;e._cardsPerRow=r}_onVerticalChange(e){var t=Math.floor;const a=this;if(a._ignoreVerticalChange)return;const r=a._visibleSource,i=a.scrollMode;let l=e.detail.value;if(a._cards.length===r.length){if(a._dataSourceProcessed&&a._partialRefresh(),a.$.scrollViewer.$.scrollViewerContentContainer.style.top=-l+"px","infinite"===i&&a.$.scrollViewer.$.verticalScrollBar.value===a.$.scrollViewer.$.verticalScrollBar.max){const e=t(l/(a._cardHeight+a._gap))*a._cardsPerRow;a._onScrollBottomReached(e,e)}return}const n=a._cardHeight+a._gap,d=a._cardsPerRow;for(clearTimeout(a._scrollingTimeout),l=l%(2*n)+n,l<n&&(l+=n);l+a.$.scrollViewer.$.scrollViewerContainer.offsetHeight>a.$.cardContainer.offsetHeight;)l-=n;let o=t(l/n)*d,s=t(e.detail.value/n)*d;0>o&&(s-=o,o=0);const c=Math.min(s+a._cards.length-o-1,r.length-1);if("virtual"===i&&(r[s].isEmpty||r[c].isEmpty)){let e;for(let t=s;t<=c;t++)if(r[t].isEmpty){e=t;break}return a.setAttribute("loading",""),a.$.loadingIndicatorContainer.classList.remove("smart-hidden"),a.$.scrollViewer.$.scrollViewerContentContainer.style.top=-l+"px",void(a._scrollingTimeout=setTimeout(function(){a.dataSource.onVirtualDataSourceRequested(a._virtualDataSourceRequestedCallback.bind(a,o,s),{first:e,last:c+1,sorting:[],filtering:[],grouping:[],action:""})},300))}a.$.scrollViewer.$.scrollViewerContentContainer.style.top=-l+"px",a._updateVisibleCards(o,s),"virtual"===i?(a.removeAttribute("loading"),a.$.loadingIndicatorContainer.classList.add("smart-hidden")):"infinite"===i&&a.$.scrollViewer.$.verticalScrollBar.value===a.$.scrollViewer.$.verticalScrollBar.max&&a._onScrollBottomReached(o,s)}_onScrollBottomReached(e,t){const a=this;a.$.loadingIndicatorContainer.classList.remove("smart-hidden"),a.dataSource.onVirtualDataSourceRequested(function(){a._updateVisibleCards(e,t);const i=Math.ceil(a._visibleSource.length/a._cardsPerRow),r=(a._cardHeight+a._gap)*i-a._gap,l=a.$.scrollViewer.$.scrollViewerContainer.offsetHeight;a.$.scrollViewer.$.verticalScrollBar.max=r-l,a._scrollHeight=r,a.$.loadingIndicatorContainer.classList.add("smart-hidden")},{first:1/0,last:1/0,sorting:[],filtering:[],grouping:[],action:""})}_updateVisibleCards(e,t,a){const r=this;for(let l=e;l<r._cards.length;l++){const i=r._cards[l],n=t+l-e;n<r._visibleSource.length?(i.classList.remove("smart-hidden"),(a||i.dataId!==n||r._dataSourceProcessed)&&r._updateVirtualCard(i,n)):i.classList.add("smart-hidden")}r._start={view:e,data:t}}_toggleColumn(e,t,a){const i=this,r=i._visibleSource;if(e&&"string"==typeof e&&e!==i.coverField&&e!==i.titleField&&r&&0!==r.length){const r=i.columns.find(t=>t.dataField===e);r&&(i._close(),i._changedVisibility=new Map,i._changedVisibility.set(r,t),i._updateColumnsVisibility(void 0,a))}}_updateVirtualCard(e,t){const a=this,i=a._visibleSource[t],r=i.$.id,l=e.firstElementChild.lastElementChild,n=a.coverField;if(e.dataId=t,l.innerHTML=a._applyTemplate(i),e.scrollTop=a._cardScrolling[r]?a._cardScrolling[r]:0,n){const t=e.getElementsByTagName("smart-carousel")[0];let a=i[n];a="string"==typeof a?a.split(","):[],t.set("dataSource",a),0<a.length&&(t._generateIndicators(),t._indicators[0].classList.add("smart-active"),t._generateItems(),t._items[0].classList.add("smart-active"))}}_updateCardHeight(e){const t=this,a=t._cards;if(null===e){let e=0;if(t._autoCardHeight=!0,a.forEach(e=>e.style.height=null),a.forEach(t=>e=Math.max(t.offsetHeight,e)),a.forEach(t=>t.style.height=e+"px"),t._cardHeight===e)return;t._cardHeight=e}else{if(t._autoCardHeight=!1,t._cardHeight===e)return;a.forEach(t=>t.style.height=e+"px"),t._cardHeight=e}t._refreshView()}_refreshView(){const e=this;e._getCardsPerRow();const t=e.$.scrollViewer.$.scrollViewerContainer.offsetHeight,a=e._cardsPerRow,i=e._cardHeight+e._gap;let r=2*t/i*a;for(r=r-r%a+a,r=Math.min(r,e._visibleSource.length);e._cards.length<r;)e._createEmptyCard();for(;e._cards.length>r;)e._cards[e._cards.length-1].remove(),e._cards.pop();for(;"infinite"===e.scrollMode&&0!=e._cards.length%a;)e._createEmptyCard();const l=e._getFractionOfMax(),n=Math.ceil(e._visibleSource.length/e._cardsPerRow),d=i*n-e._gap,o=Math.max(0,d-t);if(e.$.scrollViewer.$.verticalScrollBar.max=o,e._scrollHeight=d,e._setFractionOfMax(l),0===o)e.$.scrollViewer.refresh();else debugger}_getFractionOfMax(){const e=this.$.scrollViewer.$.verticalScrollBar;return e.value/e.max}_setFractionOfMax(e){const t=this,a=this.$.scrollViewer.$.verticalScrollBar,i=a.max*e;a.value=i,t._onVerticalChange({detail:{value:i}})}_partialRefresh(){const e=this;e._updateVisibleCards(e._start.view,e._start.data,!0)}_getVisibleRecords(){const e=this,t=e.dataSource;if(e._visibleSource=[],0===e._appliedFiltering.filters.length)e._visibleSource=t;else for(let a=0;a<t.length;a++){const t=e.dataSource[a];!1!==t.$.filtered&&e._visibleSource.push(t)}0===t.length?(e.setAttribute("empty",""),e.removeAttribute("no-matches")):(e.removeAttribute("empty"),0===e._visibleSource.length?e.setAttribute("no-matches",""):e.removeAttribute("no-matches"))}_clearFilterAndSortUI(){const e=this;e._appliedFiltering={filters:[],operator:"and"},e._appliedSorting={dataFields:[],dataTypes:[],orderBy:[]},e.$.filterButton.classList.remove("filtered"),e.$.sortButton.classList.remove("sorted"),e.$.filterButton.firstElementChild.innerHTML=e.localize("filter"),e.$.sortButton.firstElementChild.innerHTML=e.localize("sort")}});